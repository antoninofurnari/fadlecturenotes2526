name: Build PDF

on:
  push:
    branches:
      - master

# Add permissions required for the release action to create/update a release
permissions:
  contents: write

jobs:
  build-pdf:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v4 # <-- Updated to v4 for latest features and security
        with:
          persist-credentials: false

      - name: Install System Dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            fonts-liberation \
            fonts-cmu \
            texlive-latex-recommended \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            texlive-xetex \
            latexmk \
            xindy

      - name: Setup Miniconda
        uses: conda-incubator/setup-miniconda@v3
        with:
          auto-update-conda: true
          auto-activate-base: false
          miniconda-version: 'latest'
          python-version: 3.8
          environment-file: environment.yml
          activate-environment: fadlecturenotes

      - name: Build PDF with Jupyter Book
        shell: bash -l {0}
        run: |
          jb build lecturenotes/ --builder pdflatex

      - name: Upload PDF Artifact
        uses: actions/upload-artifact@v4 # <-- FIX: Updated from deprecated v3
        with:
          name: book-pdf
          path: lecturenotes/_build/latex/book.pdf

      - name: Create or Update "latest" Release
        uses: ncipollo/release-action@v1
        with:
          artifacts: lecturenotes/_build/latex/book.pdf
          allowUpdates: true
          replacesArtifacts: true
          tag: "latest"